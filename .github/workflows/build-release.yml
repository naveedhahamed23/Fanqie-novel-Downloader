name: æ„å»ºå’Œå‘å¸ƒ

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            artifact_name: windows
            executable: TomatoNovelDownloader.exe
            debug_executable: TomatoNovelDownloader-debug.exe
          - os: ubuntu-latest
            artifact_name: linux
            executable: TomatoNovelDownloader
            debug_executable: TomatoNovelDownloader-debug
          - os: macos-latest
            artifact_name: macos
            executable: TomatoNovelDownloader
            debug_executable: TomatoNovelDownloader-debug
    
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: ç”Ÿæˆç‰ˆæœ¬å·å¹¶æ›´æ–°version.py
      id: version
      shell: bash
      run: |
        VERSION=$(python -c "import datetime; print(datetime.datetime.now().strftime('%Y.%m.%d.%H%M'))")+$(echo ${{ github.sha }} | cut -c1-7)
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Generated version: $VERSION"
        
        # ç”Ÿæˆæ„å»ºæ—¶é—´
        BUILD_TIME=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')
        echo "BUILD_TIME=$BUILD_TIME" >> $GITHUB_OUTPUT
        echo "Build time: $BUILD_TIME"
        
        # ä½¿ç”¨Pythonè„šæœ¬æ›´æ–°version.pyæ–‡ä»¶
        export VERSION
        python << 'PYTHON_SCRIPT'
        import os
        version = os.environ.get('VERSION', '1.0.0')
        content = f'''# -*- coding: utf-8 -*-
        """
        ç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
        """
        
        __version__ = "{version}"
        __author__ = "Tomato Novel Downloader"
        __description__ = "A modern novel downloader with GitHub auto-update support"
        __github_repo__ = "POf-L/Fanqie-novel-Downloader"
        '''
        
        with open('version.py', 'w', encoding='utf-8') as f:
            f.write(content)
            
        print(f"Updated version.py with version: {version}")
        PYTHON_SCRIPT
        
        echo "version.py content:"
        cat version.py

    - name: å®‰è£…ç³»ç»Ÿä¾èµ– (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-tk tk-dev

    - name: å®‰è£…ç³»ç»Ÿä¾èµ– (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install tcl-tk || true

    - name: å®‰è£…ç³»ç»Ÿä¾èµ– (Windows)
      if: runner.os == 'Windows'
      run: |
        # è®¾ç½®UTF-8ç¼–ç ç¯å¢ƒå˜é‡
        echo "PYTHONIOENCODING=utf-8" >> $env:GITHUB_ENV
        echo "PYTHONUTF8=1" >> $env:GITHUB_ENV
        # Windowsé€šå¸¸è‡ªå¸¦tkinterï¼Œä½†ç¡®ä¿PyInstallerèƒ½æ‰¾åˆ°å¿…è¦çš„DLL
        echo "Windowsç³»ç»Ÿä¾èµ–æ£€æŸ¥å®Œæˆ"

    - name: ç¼“å­˜Pythonä¾èµ–
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: å‡çº§pip
      run: |
        python -m pip install --upgrade pip

    - name: å®‰è£…ä¾èµ–
      run: |
        pip install -r requirements.txt
        pip install pyinstaller
        # ç¡®ä¿Pillowå®Œæ•´å®‰è£…
        pip install --force-reinstall Pillow

    - name: éªŒè¯ä¾èµ–å®‰è£…
      env:
        PYTHONIOENCODING: utf-8
        PYTHONUTF8: 1
      run: |
        python -c "import requests, PIL, ebooklib, bs4, fake_useragent, tqdm; print('All dependencies installed successfully')"
        python -c "from PIL import Image, ImageTk, ImageDraw, ImageFile; print('PIL modules imported successfully')"
        python -c "import PIL.JpegImagePlugin, PIL.PngImagePlugin; print('PIL image plugins loaded successfully')"
        python -c "print('PIL version:', PIL.__version__)"
        python -c "print('PIL features:', PIL.features.get_supported())"
        
    - name: æµ‹è¯•å°é¢ä¸‹è½½åŠŸèƒ½
      env:
        PYTHONIOENCODING: utf-8
        PYTHONUTF8: 1
      run: |
        python -c "
        import requests
        from PIL import Image
        from io import BytesIO
        import sys
        
        # æµ‹è¯•ä¸‹è½½ä¸€å¼ æµ‹è¯•å›¾ç‰‡
        test_url = 'https://httpbin.org/image/jpeg'
        try:
            print('æ­£åœ¨æµ‹è¯•å›¾ç‰‡ä¸‹è½½...')
            resp = requests.get(test_url, timeout=10)
            resp.raise_for_status()
            print(f'å›¾ç‰‡ä¸‹è½½æˆåŠŸï¼Œå¤§å°: {len(resp.content)} bytes')
            
            # æµ‹è¯•PILå¤„ç†
            img = Image.open(BytesIO(resp.content))
            print(f'å›¾ç‰‡åŠ è½½æˆåŠŸ: {img.format}, {img.size}, {img.mode}')
            
            # æµ‹è¯•ç¼©æ”¾
            resized = img.resize((100, 100))
            print(f'å›¾ç‰‡ç¼©æ”¾æˆåŠŸ: {resized.size}')
            
        except Exception as e:
            print(f'å›¾ç‰‡å¤„ç†æµ‹è¯•å¤±è´¥: {e}')
            sys.exit(1)
        "
        
    - name: æ‰§è¡Œå°é¢åŠŸèƒ½æµ‹è¯•
      env:
        PYTHONIOENCODING: utf-8
        PYTHONUTF8: 1
      run: |
        if [ -f "test_cover.py" ]; then
          echo "è¿è¡Œå°é¢åŠŸèƒ½æµ‹è¯•..."
          python test_cover.py
        else
          echo "æµ‹è¯•è„šæœ¬ä¸å­˜åœ¨ï¼Œè·³è¿‡æµ‹è¯•"
        fi

    - name: æ£€æŸ¥æ„å»ºè„šæœ¬
      run: |
        if [ -f "build_app.py" ]; then
          echo "Found build script build_app.py"
        else
          echo "Build script not found, using default PyInstaller command"
        fi
      shell: bash

    - name: æ„å»ºåˆ†å‘ç‰ˆåº”ç”¨
      env:
        PYTHONIOENCODING: utf-8
        PYTHONUTF8: 1
      run: |
        echo "æ­£åœ¨æ„å»ºåˆ†å‘ç‰ˆ..."
        if [ -f "build_app.py" ]; then
          python build_app.py
        else
          # é»˜è®¤æ„å»ºå‘½ä»¤
          if [ -f "gui.py" ]; then
            pyinstaller --onefile --windowed --name=TomatoNovelDownloader gui.py
          elif [ -f "main.py" ]; then
            pyinstaller --onefile --name=TomatoNovelDownloader main.py
          else
            echo "æœªæ‰¾åˆ°ä¸»ç¨‹åºæ–‡ä»¶"
            exit 1
          fi
        fi
      shell: bash
      
    - name: æ„å»º Debug ç‰ˆåº”ç”¨
      env:
        PYTHONIOENCODING: utf-8
        PYTHONUTF8: 1
      run: |
        echo "æ­£åœ¨æ„å»º Debug ç‰ˆ..."
        # æ¸…ç†ä¹‹å‰çš„æ„å»ºæ–‡ä»¶
        rm -rf build/ *.spec || true
        
        # ä½¿ç”¨debug.specæ„å»ºDebugç‰ˆæœ¬
        if [ -f "debug.spec" ]; then
          echo "ä½¿ç”¨debug.specæ„å»º..."
          pyinstaller debug.spec --clean --noconfirm
        else
          # ç›´æ¥ä½¿ç”¨å‘½ä»¤è¡Œæ„å»ºDebugç‰ˆ
          pyinstaller --onefile --console --name=${{ matrix.debug_executable }} \
            --hidden-import=bs4 \
            --hidden-import=fake_useragent \
            --hidden-import=tqdm \
            --hidden-import=requests \
            --hidden-import=urllib3 \
            --hidden-import=ebooklib \
            --hidden-import=PIL \
            --hidden-import=PIL.Image \
            --hidden-import=PIL.ImageTk \
            --hidden-import=PIL.ImageDraw \
            --hidden-import=PIL.ImageFile \
            --hidden-import=PIL.ImageFont \
            --hidden-import=PIL.ImageOps \
            --hidden-import=PIL.JpegImagePlugin \
            --hidden-import=PIL.PngImagePlugin \
            --hidden-import=PIL.GifImagePlugin \
            --hidden-import=PIL.BmpImagePlugin \
            --hidden-import=PIL.WebPImagePlugin \
            --hidden-import=PIL._imaging \
            --collect-submodules=PIL \
            --debug=imports \
            gui.py
        fi
      shell: bash

    - name: éªŒè¯æ„å»ºç»“æœ
      run: |
        echo "æ£€æŸ¥æ„å»ºç»“æœ..."
        ls -la dist/ || echo "dist directory does not exist"
        
        # æ£€æŸ¥åˆ†å‘ç‰ˆ
        if [ -f "dist/${{ matrix.executable }}" ]; then
          echo "Release build successful: dist/${{ matrix.executable }}"
          echo "Release executable size: $(ls -lh dist/${{ matrix.executable }} | awk '{print $5}')"
        else
          echo "Release build failed, executable not found"
          exit 1
        fi
        
        # æ£€æŸ¥Debugç‰ˆ
        if [ -f "dist/${{ matrix.debug_executable }}" ]; then
          echo "Debug build successful: dist/${{ matrix.debug_executable }}"
          echo "Debug executable size: $(ls -lh dist/${{ matrix.debug_executable }} | awk '{print $5}')"
        else
          echo "Debug build failed, executable not found"
          exit 1
        fi
        
        echo "ä¸¤ä¸ªç‰ˆæœ¬éƒ½æ„å»ºæˆåŠŸï¼"
      shell: bash

    - name: åˆ›å»ºå‘å¸ƒåŒ…
      run: |
        mkdir -p release
        
        # å¤åˆ¶åˆ†å‘ç‰ˆ
        cp "dist/${{ matrix.executable }}" "release/"
        
        # å¤åˆ¶Debugç‰ˆ
        cp "dist/${{ matrix.debug_executable }}" "release/"
        
        # åˆ›å»º READMEæ–‡ä»¶è¯´æ˜ä¸¤ä¸ªç‰ˆæœ¬çš„åŒºåˆ«
        cat > release/README.txt << 'EOF'
Tomato Novel Downloader v${{ steps.version.outputs.VERSION }}

åŒ…å«ä¸¤ä¸ªç‰ˆæœ¬ï¼š

1. ${{ matrix.executable }} - åˆ†å‘ç‰ˆ
   - æ­£å¼ç‰ˆæœ¬ï¼Œæ— æ§åˆ¶å°è¾“å‡º
   - é€‚åˆæ—¥å¸¸ä½¿ç”¨

2. ${{ matrix.debug_executable }} - è°ƒè¯•ç‰ˆ
   - åŒ…å«è¯¦ç»†çš„æ§åˆ¶å°è¾“å‡º
   - æ–¹ä¾¿æ’æŸ¥é—®é¢˜ï¼ˆå¦‚å°é¢åŠ è½½å¤±è´¥ç­‰ï¼‰
EOF
        
        # åˆ›å»ºå‹ç¼©åŒ…
        cd release
        if [ "${{ runner.os }}" = "Windows" ]; then
          7z a "../TomatoNovelDownloader-${{ steps.version.outputs.VERSION }}-${{ matrix.artifact_name }}.zip" .
        else
          zip -r "../TomatoNovelDownloader-${{ steps.version.outputs.VERSION }}-${{ matrix.artifact_name }}.zip" .
        fi
        cd ..
        
        echo "å‘å¸ƒåŒ…åˆ›å»ºæˆåŠŸï¼ŒåŒ…å«åˆ†å‘ç‰ˆå’ŒDebugç‰ˆ"
      shell: bash

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: TomatoNovelDownloader-${{ steps.version.outputs.VERSION }}-${{ matrix.artifact_name }}
        path: |
          TomatoNovelDownloader-${{ steps.version.outputs.VERSION }}-${{ matrix.artifact_name }}.zip
        
  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    permissions:
      contents: write
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        path: artifacts/

    - name: è·å–ç‰ˆæœ¬å·å’Œæ„å»ºæ—¶é—´
      id: get_version
      run: |
        # ä»æ–‡ä»¶åä¸­æå–ç‰ˆæœ¬å·
        VERSION=$(find artifacts -name "TomatoNovelDownloader-*" -type d | head -1 | sed 's/.*TomatoNovelDownloader-\(.*\)-.*/\1/')
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Found version: $VERSION"
        
        # ç”Ÿæˆæ„å»ºæ—¶é—´ï¼ˆä¸­å›½æ—¶åŒºï¼‰
        BUILD_TIME=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')
        echo "BUILD_TIME=$BUILD_TIME" >> $GITHUB_OUTPUT
        echo "Build time: $BUILD_TIME"

    - name: æ•´ç†å‘å¸ƒæ–‡ä»¶
      run: |
        mkdir -p release
        find artifacts -name "*.zip" -exec cp {} release/ \;
        ls -la release/

    - name: åˆ›å»ºRelease
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ steps.get_version.outputs.VERSION }}
        name: TomatoNovelDownloader v${{ steps.get_version.outputs.VERSION }}
        body: |
          ## ğŸš€ è‡ªåŠ¨æ„å»ºç‰ˆæœ¬ ${{ steps.get_version.outputs.VERSION }}

          **æ„å»ºä¿¡æ¯:**
          - æ„å»ºæ—¶é—´: ${{ steps.get_version.outputs.BUILD_TIME }} (UTC+8)
          - æäº¤å“ˆå¸Œ: ${{ github.sha }}
          - åˆ†æ”¯: ${{ github.ref_name }}

          **ä¸‹è½½è¯´æ˜:**
          - Windows: `TomatoNovelDownloader-${{ steps.get_version.outputs.VERSION }}-windows.zip`
          - Linux: `TomatoNovelDownloader-${{ steps.get_version.outputs.VERSION }}-linux.zip`
          - macOS: `TomatoNovelDownloader-${{ steps.get_version.outputs.VERSION }}-macos.zip`

          **æ›´æ–°å†…å®¹:**
          ${{ github.event.head_commit.message }}

        files: release/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}