name: Build Release and Debug

on:
  workflow_dispatch:
    inputs:
      note:
        description: 'Manual trigger for Windows build (Release & Debug)'
        required: false
        default: ''
  push:
    branches:
      - main
    tags:
      - 'v*'
    paths:
      - '**/*.py'
      - 'build.spec'
      - 'debug.spec'
      - '.github/workflows/build-release.yml'
  pull_request:
    branches:
      - main

permissions:
  contents: write

concurrency:
  group: build-release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: ${{ matrix.config.os }} PyInstaller (${{ matrix.config.variant }}) ğŸš€
    runs-on: ${{ matrix.config.os }}
    strategy:
      fail-fast: false
      matrix:
        # ä½¿ç”¨GitHubå…è´¹æœ€å¼ºå¤§çš„ runner ğŸ†“âœ¨
        config:
          - os: windows-2022            # å…è´¹æœ€å¼ºWindows: 4æ ¸CPU, 16GB RAM, 14GB SSD
            variant: release
            spec: build.spec
            exe: TomatoNovelDownloader.exe
            artifact_name: TomatoNovelDownloader-windows-x64
          - os: windows-2022
            variant: debug
            spec: debug.spec
            exe: TomatoNovelDownloader-debug.exe
            artifact_name: TomatoNovelDownloader-debug-windows-x64
          - os: ubuntu-22.04            # å…è´¹æœ€å¼ºUbuntu: 4æ ¸CPU, 16GB RAM, 14GB SSD  
            variant: release
            spec: build.spec
            exe: TomatoNovelDownloader
            artifact_name: TomatoNovelDownloader-linux-x64
          - os: ubuntu-22.04
            variant: debug
            spec: debug.spec
            exe: TomatoNovelDownloader-debug
            artifact_name: TomatoNovelDownloader-debug-linux-x64
          - os: macos-14                # å…è´¹æœ€å¼ºmacOS: 3æ ¸Apple M1, 14GB RAM, 14GB SSD
            variant: release
            spec: build.spec
            exe: TomatoNovelDownloader
            artifact_name: TomatoNovelDownloader-macos-arm64
          - os: macos-14
            variant: debug
            spec: debug.spec
            exe: TomatoNovelDownloader-debug
            artifact_name: TomatoNovelDownloader-debug-macos-arm64
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-tk tk-dev

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install tcl-tk || true

      - name: å……åˆ†åˆ©ç”¨ç¼“å­˜åŠ é€Ÿä¾èµ–å®‰è£… ğŸ’¾
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.cache/pyinstaller
          key: ${{ matrix.config.os }}-${{ matrix.config.variant }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ matrix.config.os }}-${{ matrix.config.variant }}-pip-
            ${{ matrix.config.os }}-pip-
            
      - name: é«˜é€Ÿå®‰è£…ä¾èµ– âš¡
        shell: bash  # å¼ºåˆ¶ä½¿ç”¨bashè§£å†³è·¨å¹³å°å…¼å®¹æ€§
        run: |
          # ä½¿ç”¨æœ€å¿«çš„pipé…ç½®å’Œå¤šçº¿ç¨‹å®‰è£…
          python -m pip install -U pip setuptools wheel --disable-pip-version-check --no-warn-script-location
          # å¹¶è¡Œä¸‹è½½å’Œå®‰è£…ï¼Œåˆ©ç”¨å¤šæ ¸CPU
          pip install --upgrade -r requirements.txt
          pip install --upgrade "pyinstaller>=6.5,<7" "pyinstaller-hooks-contrib>=2024.7"

      - name: Build (${{ matrix.config.variant }}) ğŸš€
        env:
          # è®¾ç½®ç¯å¢ƒå˜é‡ä»¥å……åˆ†åˆ©ç”¨å…è´¹runnerçš„æ‰€æœ‰CPUæ ¸å¿ƒ
          PYINSTALLER_COMPILE_PROCESSES: 0  # ä½¿ç”¨æ‰€æœ‰å¯ç”¨CPUæ ¸å¿ƒ(4æ ¸)
          PYTHONOPTIMIZE: 2                 # æœ€é«˜çº§åˆ«Pythonä¼˜åŒ–
          OMP_NUM_THREADS: 4                 # å……åˆ†åˆ©ç”¨å…è´¹runnerçš„4ä¸ªCPUæ ¸å¿ƒ
        shell: bash  # å¼ºåˆ¶ä½¿ç”¨bashè§£å†³Windows PowerShellé—®é¢˜
        run: |
          echo "ğŸ†“âœ¨ å¼€å§‹å…è´¹æœ€å¼ºæ€§èƒ½æ„å»ºï¼Œä½¿ç”¨ $(nproc 2>/dev/null || sysctl -n hw.ncpu 2>/dev/null || echo '4') ä¸ªCPUæ ¸å¿ƒ, 16GBå†…å­˜"
          # å…è´¹runneræœ€å¤§åŒ–æ€§èƒ½ä¼˜åŒ–PyInstalleræ„å»ºå‚æ•°
          python -m PyInstaller \
            --clean \
            --noconfirm \
            --log-level=ERROR \
            --workpath=./build \
            --distpath=./dist \
            --onefile \
            --optimize=2 \
            --strip \
            --noupx \
            --exclude-module matplotlib \
            --exclude-module pandas \
            --exclude-module numpy \
            --exclude-module scipy \
            ${{ matrix.config.spec }}
          echo "âœ… æ„å»ºå®Œæˆï¼æ–‡ä»¶å¤§å°: $(ls -lh dist/${{ matrix.config.exe }} 2>/dev/null | awk '{print $5}' || echo 'Unknown')"

      - name: Show dist contents
        run: |
          ls -la dist/ || dir dist\

      - name: Upload artifact (${{ matrix.config.variant }})
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.config.artifact_name }}
          path: dist/${{ matrix.config.exe }}
          if-no-files-found: error
          retention-days: 7
          compression-level: 9  # æœ€é«˜å‹ç¼©çº§åˆ«

  attach-to-release:
    name: Attach artifacts to Release
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # å¦‚æœæ˜¯tagï¼Œä½¿ç”¨tagåç§°
            VERSION=${GITHUB_REF#refs/tags/}
          else
            # å¦‚æœæ˜¯mainåˆ†æ”¯ï¼Œç”Ÿæˆè‡ªåŠ¨ç‰ˆæœ¬å·
            VERSION=$(date -u +'%Y.%m.%d.%H%M')+$(echo ${{ github.sha }} | cut -c1-7)
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Generated version: $VERSION"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create/Update GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.VERSION }}
          name: TomatoNovelDownloader v${{ steps.version.outputs.VERSION }}
          body: |
            ## ${{ github.event.head_commit.message }}
            
            **æ„å»ºä¿¡æ¯:**
            - æ„å»ºæ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
            - æäº¤å“ˆå¸Œ: ${{ github.sha }}
            - åˆ†æ”¯: ${{ github.ref_name }}
            - æäº¤è€…: ${{ github.event.head_commit.author.name }}

            **æ”¯æŒå¹³å°:**
            - ğŸ’» Windows (x64): `TomatoNovelDownloader-windows.exe` + debugç‰ˆ
            - ğŸ§ Linux (x64): `TomatoNovelDownloader-linux` + debugç‰ˆ  
            - ğŸ macOS (Apple Silicon): `TomatoNovelDownloader-macos-arm64` + debugç‰ˆ

            **ç‰ˆæœ¬ç‰¹æ€§:**
            - âœ… åˆ†å‘ç‰ˆå’ŒDebugç‰ˆåŒæ„å»ºæ”¯æŒ
            - âœ… Debugç‰ˆæœ¬åŒ…å«è¯¦ç»†æ—¥å¿—ï¼Œä¾¿äºé—®é¢˜æ’æŸ¥
            - âœ… å¢å¼ºçš„å°é¢ä¸‹è½½å’ŒPILå›¾ç‰‡å¤„ç†
            - âœ… è·¨å¹³å°æ”¯æŒï¼ˆWindows/Linux/macOSï¼‰
            - ğŸš€ ä½¿ç”¨GitHubé«˜æ€§èƒ½ runneråŠ é€Ÿæ„å»º

            **ä½¿ç”¨è¯´æ˜:**
            - åˆ†å‘ç‰ˆï¼šæ­£å¸¸ä½¿ç”¨çš„ç‰ˆæœ¬ï¼Œæ— æ§åˆ¶å°è¾“å‡º
            - Debugç‰ˆï¼šåŒ…å«è¯¦ç»†è°ƒè¯•ä¿¡æ¯ï¼Œé‡åˆ°é—®é¢˜æ—¶ä½¿ç”¨

          files: |
            artifacts/**/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}