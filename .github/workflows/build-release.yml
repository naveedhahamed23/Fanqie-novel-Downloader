name: Build Release and Debug

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows æ„å»º
          - os: windows-latest
            variant: release
            executable: TomatoNovelDownloader.exe
            artifact_name: TomatoNovelDownloader-windows
          - os: windows-latest
            variant: debug
            executable: TomatoNovelDownloader-debug.exe
            artifact_name: TomatoNovelDownloader-debug-windows
          # Linux æ„å»º
          - os: ubuntu-latest
            variant: release
            executable: TomatoNovelDownloader-linux
            artifact_name: TomatoNovelDownloader-linux
          - os: ubuntu-latest
            variant: debug
            executable: TomatoNovelDownloader-debug-linux
            artifact_name: TomatoNovelDownloader-debug-linux
          # macOS æ„å»º
          - os: macos-latest
            variant: release
            executable: TomatoNovelDownloader-macos
            artifact_name: TomatoNovelDownloader-macos
          - os: macos-latest
            variant: debug
            executable: TomatoNovelDownloader-debug-macos
            artifact_name: TomatoNovelDownloader-debug-macos

    runs-on: ${{ matrix.os }}
    name: ${{ matrix.os }} - ${{ matrix.variant }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-tk tk-dev

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install tcl-tk || true

      - name: Generate version and update version.py
        id: version
        run: |
          VERSION=$(date -u +'%Y.%m.%d.%H%M')+$(echo ${{ github.sha }} | cut -c1-7)
          BUILD_TIME=$(date -u +'%Y-%m-%d %H:%M:%S UTC')
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "BUILD_TIME=$BUILD_TIME" >> $GITHUB_OUTPUT
          echo "Generated version: $VERSION"
          echo "Build time: $BUILD_TIME"
          
          # æ›´æ–°version.pyæ–‡ä»¶
          cat > version.py << EOF
# -*- coding: utf-8 -*-
"""
ç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶ - GitHub Actionsè‡ªåŠ¨ç”Ÿæˆ
"""

__version__ = "$VERSION"
__author__ = "Tomato Novel Downloader"
__description__ = "A modern novel downloader with GitHub auto-update support"
__github_repo__ = "POf-L/Fanqie-novel-Downloader"
__build_time__ = "$BUILD_TIME"
EOF
          
          echo "æ›´æ–°åçš„version.py:"
          cat version.py
        shell: bash

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build application (${{ matrix.variant }})
        run: |
          if [ "${{ matrix.variant }}" == "debug" ]; then
            # Debugç‰ˆæœ¬ - å¸¦æ§åˆ¶å°
            pyinstaller --onefile --console --name=${{ matrix.executable }} \
              --hidden-import=bs4 \
              --hidden-import=fake_useragent \
              --hidden-import=tqdm \
              --hidden-import=requests \
              --hidden-import=urllib3 \
              --hidden-import=ebooklib \
              --hidden-import=PIL \
              --hidden-import=PIL.Image \
              --hidden-import=PIL.ImageTk \
              --hidden-import=PIL.ImageDraw \
              --hidden-import=PIL.ImageFile \
              --hidden-import=PIL.JpegImagePlugin \
              --hidden-import=PIL.PngImagePlugin \
              gui.py
          else
            # Releaseç‰ˆæœ¬ - çª—å£æ¨¡å¼
            pyinstaller --onefile --windowed --name=${{ matrix.executable }} \
              --hidden-import=bs4 \
              --hidden-import=fake_useragent \
              --hidden-import=tqdm \
              --hidden-import=requests \
              --hidden-import=urllib3 \
              --hidden-import=ebooklib \
              --hidden-import=PIL \
              --hidden-import=PIL.Image \
              --hidden-import=PIL.ImageTk \
              --hidden-import=PIL.ImageDraw \
              --hidden-import=PIL.ImageFile \
              --hidden-import=PIL.JpegImagePlugin \
              --hidden-import=PIL.PngImagePlugin \
              gui.py
          fi
        shell: bash

      - name: Verify build
        run: |
          ls -la dist/
          if [ -f "dist/${{ matrix.executable }}" ]; then
            echo "âœ… Build successful: ${{ matrix.executable }}"
            echo "File size: $(ls -lh dist/${{ matrix.executable }} | awk '{print $5}')"
          else
            echo "âŒ Build failed: ${{ matrix.executable }} not found"
            exit 1
          fi
        shell: bash

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: dist/${{ matrix.executable }}
          if-no-files-found: error

  release:
    name: Create Release
    if: github.ref == 'refs/heads/main'
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version from build
        id: version
        run: |
          # ä½¿ç”¨ä¸build jobä¸­ç›¸åŒçš„é€»è¾‘ç”Ÿæˆç‰ˆæœ¬å·
          VERSION=$(date -u +'%Y.%m.%d.%H%M')+$(echo ${{ github.sha }} | cut -c1-7)
          BUILD_TIME=$(date -u +'%Y-%m-%d %H:%M:%S UTC')
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "BUILD_TIME=$BUILD_TIME" >> $GITHUB_OUTPUT
          echo "Using version: $VERSION"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.VERSION }}
          name: TomatoNovelDownloader v${{ steps.version.outputs.VERSION }}
          body: |
            ## ${{ github.event.head_commit.message }}
            
            **æ„å»ºä¿¡æ¯:**
            - æ„å»ºæ—¶é—´: ${{ steps.version.outputs.BUILD_TIME }}
            - æäº¤å“ˆå¸Œ: ${{ github.sha }}
            - åˆ†æ”¯: ${{ github.ref_name }}
            - æäº¤è€…: ${{ github.event.head_commit.author.name }}

            **æ”¯æŒå¹³å°:**
            - ğŸ’» Windows (x64): `TomatoNovelDownloader-windows` + debugç‰ˆ
            - ğŸ§ Linux (x64): `TomatoNovelDownloader-linux` + debugç‰ˆ  
            - ğŸ macOS: `TomatoNovelDownloader-macos` + debugç‰ˆ

            **ä½¿ç”¨è¯´æ˜:**
            - åˆ†å‘ç‰ˆï¼šæ­£å¸¸ä½¿ç”¨çš„ç‰ˆæœ¬ï¼Œæ— æ§åˆ¶å°è¾“å‡º
            - Debugç‰ˆï¼šåŒ…å«è¯¦ç»†è°ƒè¯•ä¿¡æ¯ï¼Œé‡åˆ°é—®é¢˜æ—¶ä½¿ç”¨

          files: |
            artifacts/**/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}